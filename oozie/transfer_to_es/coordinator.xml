<?xml version="1.0" encoding="UTF-8"?>
<coordinator-app xmlns="uri:oozie:coordinator:0.4"
    name="transfer_to_cirrussearch-coord"
    frequency="${coord:days(days_aggregated)}"
    start="${start_time}"
    end="${stop_time}"
    timezone="Universal">

    <!-- NOTE: You cannot override coordinator.properties values here -->
    <parameters>
        <!-- Required properties. -->
        <property><name>workflow_file</name></property>
        <property><name>start_time</name></property>
        <property><name>stop_time</name></property>
    </parameters>

    <controls>
        <!--
        This job only runs once a week, we can be patient and wait up to
        24 hours for the data to be ready.
        -->
        <timeout>1440</timeout>

        <!--
        Really we should fail anything other than the newest version, sending
        an old one only to overwrite it is a bit silly. But 1 is the lowest this
        goes.
        -->
        <concurrency>1</concurrency>

        <!--
        Since we expect only one incarnation per weekly dataset, the
        default throttle of 12 is way to high, and there is no need
        to keep that many materialized jobs around.
        -->
        <throttle>1</throttle>
    </controls>

    <datasets>
        <!--
        Include discovery datasets files.
        $discovery_datasets_file will be used as the output events
        -->
        <include>${discovery_datasets_file}</include>
    </datasets>

    <input-events>
        <data-in name="popularity_score_input" dataset="popularity_score">
            <instance>${coord:current(0)}</instance>
        </data-in>
    </input-events>

    <output-events>
        <data-out name="popularity_score_esbulk_output" dataset="popularity_score_esbulk">
            <instance>${coord:current(0)}</instance>
        </data-out>
    </output-events>

    <action>
        <workflow>
            <app-path>${workflow_file}</app-path>
            <configuration>
                <property>
                    <name>popularity_score_partition_directory</name>
                    <value>${coord:dataIn('popularity_score_input')}</value>
                </property>
                <property>
                    <name>popularity_score_esbulk_partition_directory</name>
                    <value>${coord:dataOut('popularity_score_esbulk_output')}</value>
                </property>
                <property>
                    <name>current_esbulk_partition</name>
                    <value>${coord:formatTime(coord:nominalTime(), "yyyyMMdd")}</value>
                </property>
            </configuration>
        </workflow>
    </action>
</coordinator-app>
